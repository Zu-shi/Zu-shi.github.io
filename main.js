// Todo: have a global that gets the x, y, width, height of preview box at any moment
var Events = [{"Name":"The Grey Black and White Agree on Grey","X":6134,"Y":2414,"Radius":275},{"Name":"Ground of Being","X":8258,"Y":2249,"Radius":1450},{"Name":"Wings in Self-Strum","X":4666,"Y":2614,"Radius":1450},{"Name":"Wonder Cloud","X":7747,"Y":2825,"Radius":940},{"Name":"Conversation of Quanta","X":959,"Y":3056,"Radius":940},{"Name":"Burst of Solar Structure","X":12199,"Y":2124,"Radius":940},{"Name":"Far Off Emergence","X":1069,"Y":1393,"Radius":940},{"Name":"Present Opalessence","X":11261,"Y":1402,"Radius":940},{"Name":"Architecture","X":4303,"Y":2268,"Radius":940},{"Name":"unfathomable quantum","X":10602,"Y":4411,"Radius":940},{"Name":"Boundless Being","X":8482,"Y":3225,"Radius":940},{"Name":"Layer and Structure","X":3547,"Y":3580,"Radius":940},{"Name":"Here and Now","X":2564,"Y":1857,"Radius":940},{"Name":"Sub Surface Covergence","X":2259,"Y":956,"Radius":940},{"Name":"Inbreath","X":11715,"Y":982,"Radius":940},{"Name":"Awareness Machine","X":10015,"Y":1736,"Radius":940},{"Name":"Feminine Aspect","X":10515,"Y":1700,"Radius":940},{"Name":"Convergence of Spirit","X":8441,"Y":2317,"Radius":940},{"Name":"Preceeding Quanta","X":15399,"Y":958,"Radius":940},{"Name":"Outbreath","X":13543,"Y":1056,"Radius":940},{"Name":"Waves of Ether Into Base Quanta","X":14002,"Y":3433,"Radius":940},{"Name":"Proof of Sun","X":7595,"Y":1945,"Radius":550},{"Name":"Convergence Engine","X":11323,"Y":2046,"Radius":550},{"Name":"Seed of Intention","X":9476,"Y":2662,"Radius":550},{"Name":"Livid Life","X":7904,"Y":757,"Radius":550},{"Name":"Dance of Duality","X":8628,"Y":1344,"Radius":550},{"Name":"Season of Artificial Intelegence","X":7445,"Y":3397,"Radius":550},{"Name":"Life of Leaf","X":6844,"Y":3444,"Radius":550},{"Name":"open hear","X":10816,"Y":3338,"Radius":550},{"Name":"Wave Form","X":10295,"Y":1956,"Radius":550},{"Name":"Helic of Intertwining Self and Other","X":6499,"Y":2547,"Radius":550},{"Name":"Echos of Conversation","X":6242,"Y":2560,"Radius":550},{"Name":"Friction Formula","X":968,"Y":3383,"Radius":550},{"Name":"Fading Architecture, Entropy Affecter","X":4092,"Y":602,"Radius":550},{"Name":"Life Line","X":7577,"Y":3715,"Radius":550},{"Name":"Wisps of Sight","X":2364,"Y":3636,"Radius":550},{"Name":"Duality Bites","X":10617,"Y":2196,"Radius":550},{"Name":"Dimensional Breach","X":6160,"Y":1388,"Radius":550},{"Name":"Horn of Musical Matters","X":10202,"Y":2630,"Radius":550},{"Name":"cloud form","X":5050,"Y":1156,"Radius":550},{"Name":"The floop of fwee","X":5641,"Y":3975,"Radius":550},{"Name":"Lunminous Wing","X":6425,"Y":1785,"Radius":550},{"Name":"Boundless Being","X":8262,"Y":3375,"Radius":550},{"Name":"Song of the Soul","X":8223,"Y":1737,"Radius":550},{"Name":"Diathanous Games with Cumulous Intent","X":11051,"Y":2246,"Radius":550},{"Name":"Airfoil","X":6478,"Y":2004,"Radius":550},{"Name":"Sense Alchemy","X":9185,"Y":1533,"Radius":550},{"Name":"Sleek Curiosity","X":8644,"Y":3121,"Radius":550},{"Name":"pretend occurrence","X":9855,"Y":1530,"Radius":550},{"Name":"Draft point","X":6473,"Y":2219,"Radius":550},{"Name":"Stratified Concious Side","X":8777,"Y":1141,"Radius":550},{"Name":"Gestures of rhythm","X":6353,"Y":2843,"Radius":550},{"Name":"Flutter Form","X":4366,"Y":2595,"Radius":550},{"Name":"Felling Fumes","X":9660,"Y":1935,"Radius":550},{"Name":"Vertext convergence Context Emergence","X":6719,"Y":2223,"Radius":550},{"Name":"Melodic Action","X":6737,"Y":1417,"Radius":550},{"Name":"wedges of transience","X":7058,"Y":2468,"Radius":550},{"Name":"Wafts of Vision","X":558,"Y":3893,"Radius":550},{"Name":"Twinkling \"I","X":6089,"Y":1679,"Radius":275},{"Name":"Wriggle of Spirit","X":8653,"Y":1823,"Radius":275},{"Name":"convergence Engine","X":11019,"Y":1870,"Radius":275},{"Name":"Artifacts of spirit","X":4966,"Y":2718,"Radius":275},{"Name":"Frequent - See","X":9542,"Y":2686,"Radius":275},{"Name":"Motion-Forge Radical","X":5776,"Y":2296,"Radius":275},{"Name":"Perk of Will","X":9312,"Y":2484,"Radius":275},{"Name":"illusive bridge","X":5756,"Y":1588,"Radius":275},{"Name":"occam's razor","X":5144,"Y":2576,"Radius":275},{"Name":"The Floop Of Fwee","X":5970,"Y":4038,"Radius":275},{"Name":"Support Agent","X":7069,"Y":3733,"Radius":275},{"Name":"The Shadow Self","X":9940,"Y":2612,"Radius":275},{"Name":"The Point","X":8414,"Y":300,"Radius":275},{"Name":"Elemental Influx","X":9454,"Y":1373,"Radius":275},{"Name":"High Octane Experience","X":6644,"Y":1144,"Radius":275},{"Name":"Shine Refinery","X":8547,"Y":2832,"Radius":275},{"Name":"Wink By Gleaming Glint","X":9765,"Y":2094,"Radius":275},{"Name":"Cubic Kiss","X":5009,"Y":2902,"Radius":275},{"Name":"propagation artifact","X":9447,"Y":1685,"Radius":275},{"Name":"Qauntum attraction","X":1055,"Y":3820,"Radius":275},{"Name":"Tree of Life","X":7112,"Y":2264,"Radius":275},{"Name":"Rhythm of Self Assembly","X":6335,"Y":3511,"Radius":275},{"Name":"Form Curl to Curl","X":1409,"Y":3722,"Radius":275},{"Name":"love Language","X":8867,"Y":920,"Radius":275},{"Name":"percussive lifeforce","X":7883,"Y":1407,"Radius":275},{"Name":"Charming Veneer","X":5106,"Y":2193,"Radius":275},{"Name":"Space Thread","X":7433,"Y":1395,"Radius":275}]
console.log(Events);

// box = 1374x334
// start point = 1232x256
// 3840x2160

var web = new Image();
web.onload = function(){
	RedrawCanvas();
}
web.src = 'Assets\\BBB_website_design_4k.webp';

var decorative = new Image();
decorative.onload = function(){
	RedrawCanvas();
}
decorative.src = 'Assets\\CCC_Decorative_Elements.webp';

var scrollbackground = new Image();
scrollbackground.onload = function(){
	RedrawCanvas();
}
scrollbackground.src = 'Assets\\Brackground for Scroll List.webp';

var looking_glass = new Image();
looking_glass.onload = function(){
	RedrawCanvas();
}
looking_glass.src = 'Assets\\EEE_Looking_Glass_No_Vert_Bar.webp';

var unity = new Image();
unity.onload = function(){
	RedrawCanvas();
}
unity.src = 'Assets\\AAA_We_Are_Unity_(WebP 90_).webp';

/*
var eventFont = new FontFace('myFont', 'url(Assets\\GABRIOLA.TTF)');
eventFont.load().then(function(font){
  // with canvas, if this is ommited won't work
  document.fonts.add(font);
  console.log('Font loaded');
});
*/

const overall_width = 3840
const overall_height = 2160
const overall_startx = 1232
const overall_starty = 256
const box_width = 1382
const box_height = 334
const aspect_ratio = overall_width / overall_height;

const circle_center_x = 1920
const circle_center_y = 1200
const circle_radius = 420
const unity_width = 16295
const unity_height = 4000

const event_coords_ratio = 0.88186

const min_width = 1280
const min_height = 720

let currently_in_box = false
let reordering_menu_dissapeared = true
let cached_event_ordering = []
let oddlist = []
let evenlist = []
let oddlist_cached = []
let evenlist_cached = []
let cachedEvent = {clientX: 0, clientY: 0}

let current_fps_second = 0;
let frames_kept = 0;
let current_fps = 0;

/*
const ms_per_second = 1000;
const refresh_interval = 1 * ms_per_second;
const fade_in_out_interval = 0.4;
*/

let last_refresh_time_ms = Date.now();
let last_change_time_ms = Date.now();
let last_mouse_move_time_ms = Date.now();
const recheck_interval_ms = 100
const wait_mouse_still_seconds_for_list_change = 200
const fade_out_ms = 400
const fade_in_ms = 400

var getTextHeight = function(font) {

  var text = $('<span>Hg</span>').css({ fontFamily: font });
  var block = $('<div style="display: inline-block; width: 1px; height: 0px;"></div>');

  var div = $('<div></div>');
  div.append(text, block);

  var body = $('body');
  body.append(div);

  try {

    var result = {};

    block.css({ verticalAlign: 'baseline' });
    result.ascent = block.offset().top - text.offset().top;

    block.css({ verticalAlign: 'bottom' });
    result.height = block.offset().top - text.offset().top;

    result.descent = result.height - result.ascent;

  } finally {
    div.remove();
  }

  return result;
}
  
function DrawImage(ctx, img, x, y, width, height)
{
	ctx.drawImage(img.width, img.height, x, y, width, height)
}

function DrawCircle(ctx, x, y, radius, color)
{
	console.log(x, y, radius)
	ctx.globalAlpha = 0.3;
	ctx.strokeStyle = '#FFFFFF'
	ctx.lineWidth = 2
	ctx.beginPath();
	ctx.arc(x, y, radius, 0, 2 * Math.PI);
	ctx.stroke();
	ctx.globalAlpha = 1;
}

function DrawCross(ctx, x, y, radius, color)
{
	console.log(x, y, radius)

	ctx.moveTo(x - radius, y);
	ctx.lineTo(x + radius, y);

	ctx.moveTo(x, y - radius);
	ctx.lineTo(x, y + radius);

	//ctx.beginPath();
	//ctx.arc(x, y, radius, 0, 2 * Math.PI);
	//ctx.stroke();
}

function GetMainRegion(c)
{
	var ctx = c.getContext("2d");

	bodyHeight = Math.max(c.height, min_height);
	bodyWidth = c.width;

	var bodyRatio = bodyWidth / bodyHeight;
	// console.log(bodyWidth, bodyHeight);


	// We need to create a scrollbar to use
	// In the case that width is smaller than implied by height, then the width is equal to ratio to height.
	// In the case that the width is higher, then a scrollbar is not needed.
	$("#scrollbox").width(bodyHeight * bodyRatio).height(bodyHeight);
	$("#scrollbox").width(1080).height(720);

	// Center the body horizontally by calculating the width of the image
	var new_overall_width = bodyHeight / overall_height * overall_width;
	
	// The height is just height of HTML
	var new_overall_height = bodyHeight;

	var x = 0;
	if (bodyRatio > aspect_ratio)
	{
		// If page ratio is greather than background ratio, we have horizontal spaces
		// The space you should give is (bodyRatio - Aspect_Ratio) / 2 * new_overall_height
		x = (bodyRatio - aspect_ratio) / 2 * new_overall_height;
	}

	var obj = {
	    x: x,
	    y: 0,
	   	width: new_overall_width,
	    height: new_overall_height,
	};

	return obj;
}

function GetBoxCoordsFromNormalizeds(c, x_n, y_n)
{
	var yratio = c.height / overall_height;
	var xratio = yratio;
	var yposition = yratio * overall_starty;
	var xposition = xratio * overall_startx;

	var r = GetMainRegion(c);
	var obj = {
	    x: r.x + xposition + x_n * xratio * box_width,
	    y: r.y + yposition + y_n * yratio * box_height,
	};

	return obj;
}

function GetNormalizedsFromBoxCoords(c, x, y)
{
	var yratio = c.height / overall_height;
	var xratio = yratio;
	var yposition = yratio * overall_starty;
	var xposition = xratio * overall_startx;

	var r = GetMainRegion(c);

	var xs = (x - (r.x + xposition)) / (xratio * box_width);
	var ys = (y - (r.y + yposition)) / (yratio * box_height);

	var obj = {
	    x: xs,
	    y: ys,
	};

	return obj;
}

function IsInBox(c, x, y)
{
	var coords = GetNormalizedsFromBoxCoords(c, x, y);
	return coords.x > 0 && coords.x < 1 && coords.y > 0 && coords.y < 1;
}

function DrawScrollArea(c)
{
	var ctx = c.getContext("2d");
	ctx.drawImage(scrollbackground, r.x, r.y, r.width, r.height);

	var ctx = c.getContext("2d");
	startxy = GetMainRegion(c);

	// Shadow starts at 340
	// Let font size remain the same
	const full_start_location_x = 340
	starty = startxy.y + 30;
	font_size = 18;
	starting_location_x = full_start_location_x / overall_width * startxy.width + startxy.x;

	ctx.globalAlpha = 0.7;
	for (let i in Events)
	{
		//ctx.font = "lighter " + text_size_to_body_ratio + "px Times New Roman";ctx.font = "lighter " + text_size_to_body_ratio + "px Times New Roman";
		ctx.font = "lighter " + font_size + "px Gabriola";
		ctx.fillStyle = "#eeeeee";
		ctx.fillText(Events[i]["Name"], starting_location_x, starty);
		starty += (font_size * 2);
	}

	ctx.globalAlpha = 1;
}

function GetDistance(x1, y1, x2, y2)
{
	return Math.sqrt((x1 - x2) ** 2 + (y1 - y2) ** 2)
}

let n = 0;
let m = 0;

// Clamp number between two values with the following line:
const clamp = (num, min, max) => Math.min(Math.max(num, min), max);

function DrawReorderingArea(c)
{

	var ctx = c.getContext("2d");
	startxy = GetMainRegion(c);

	// Shadow starts at 340
	// Let font size remain the same
	const full_centering_location_x = 380
	starty = startxy.y + 30;
	font_size = 30;
	centering_location_x = full_centering_location_x / overall_width * startxy.width + startxy.x; 
	const font = "lighter " + font_size + "px Gabriola";

	ctx.globalAlpha = 0.7;
	// Get distance
	
	let current_time_ms = Date.now();
	
	if (IsInBox(c, mouse_current_pos_x, mouse_current_pos_y))
	{
		let mouse = getMousePosition(cachedEvent);

		let normalizedPos = GetNormalizedsFromBoxCoords(c, mouse_target_pos_x, mouse_target_pos_y);
		let unityPosX = normalizedPos.x * unity_width
		let unityPosY = normalizedPos.y * unity_height

		if (!currently_in_box && reordering_menu_dissapeared)
		{
			// Create new default ordering
			currently_in_box = true;

			console.log(Events)
			//console.log("nums")
			//console.log(unityPosX)
			//console.log(unityPosY)

			cached_event_ordering = []
			for (let i = 0; i < Events.length; i++)
			{
				var dist = GetDistance(Events[i]["X"] * event_coords_ratio, Events[i]["Y"] * event_coords_ratio, unityPosX, unityPosY);
				var item = {"index": i, "distance": dist};
				cached_event_ordering.push(item);
			}

			console.log("lists")
			console.log(JSON.stringify(cached_event_ordering))

			cached_event_ordering.sort((a,b) => (a.distance > b.distance) ? 1 : ((a.distance < b.distance) ? -1 : 0))
			oddlist = []
			evenlist = []

			for (let i = 0; i < cached_event_ordering.length; i++)
			{
				i % 2 == 0 ? evenlist.push(cached_event_ordering[i]) : oddlist.push(cached_event_ordering[i]);
			}
		}
		else if (currently_in_box)
		{
			let oddlist_temp = JSON.parse(JSON.stringify(oddlist));
			let evenlist_temp = JSON.parse(JSON.stringify(evenlist));

			if ((current_time_ms - last_refresh_time_ms) > recheck_interval_ms)
			{
				last_refresh_time_ms = current_time_ms;

				if (current_time_ms - last_mouse_move_time_ms > wait_mouse_still_seconds_for_list_change)
				{
					for (let i = 0; i < oddlist.length; i++)
					{
						oddlist[i]["distance"] = GetDistance(Events[oddlist[i]["index"]]["X"] * event_coords_ratio, Events[oddlist[i]["index"]]["Y"] * event_coords_ratio, unityPosX, unityPosY);
					}
					oddlist.sort((a,b) => (a.distance > b.distance) ? 1 : ((a.distance < b.distance) ? -1 : 0))

					for (let i = 0; i < evenlist.length; i++)
					{
						evenlist[i]["distance"] = GetDistance(Events[evenlist[i]["index"]]["X"] * event_coords_ratio, Events[evenlist[i]["index"]]["Y"] * event_coords_ratio, unityPosX, unityPosY);
					}
					evenlist.sort((a,b) => (a.distance > b.distance) ? 1 : ((a.distance < b.distance) ? -1 : 0))

					let changed = false

					for (let i = 0; i < 15; i++)
					{
						if(oddlist_temp[i]["index"] != oddlist[i]["index"]) changed = true;
					}
					for (let i = 0; i < 15; i++)
					{
						if(evenlist_temp[i]["index"] != evenlist[i]["index"]) changed = true;
					}

					if (changed)
					{
						oddlist_cached = oddlist_temp
						evenlist_cached = evenlist_temp
						last_change_time_ms = last_refresh_time_ms
					}
				}
			}
		}

		let time_elapsed = current_time_ms - last_change_time_ms

		if (time_elapsed < fade_out_ms)
		{
			current_alpha = 1 - time_elapsed / fade_out_ms 
		}
		else if (time_elapsed < fade_out_ms + fade_in_ms)
		{
			oddlist_cached = oddlist
			evenlist_cached = evenlist
			current_alpha = (time_elapsed - fade_out_ms) / fade_in_ms
		}
		else
		{
			current_alpha = 1
		}

		ctx.globalAlpha = clamp(current_alpha, 0, 1);

		// Odd on top, even below.
		const full_centering_location_y = 1188
		const centering_location_y = full_centering_location_y / overall_height * startxy.height; 
		let font_height = getTextHeight(font).height;
		font_height = 0;

		starty = centering_location_y;
		for (let i in evenlist_cached)
		{
			//ctx.font = "lighter " + text_size_to_body_ratio + "px Times New Roman";ctx.font = "lighter " + text_size_to_body_ratio + "px Times New Roman";
			ctx.font = font
			ctx.fillStyle = "#eeeeee";
			var measureText = ctx.measureText(Events[evenlist_cached[i]["index"]]["Name"]);
			ctx.fillText(Events[evenlist_cached[i]["index"]]["Name"], 
				centering_location_x - measureText.width / 2, 
				starty - font_height / 2);
			starty += (font_size * 1.5);
		}

		starty = centering_location_y - (font_height / 2) - (oddlist.length) * (font_size * 1.5);
		for (let i in oddlist_cached)
		{
			//ctx.font = "lighter " + text_size_to_body_ratio + "px Times New Roman";ctx.font = "lighter " + text_size_to_body_ratio + "px Times New Roman";
			ctx.font = font
			ctx.fillStyle = "#eeeeee";
			var measureText = ctx.measureText(Events[oddlist_cached[i]["index"]]["Name"]);
			ctx.fillText(Events[oddlist_cached[i]["index"]]["Name"], 
				centering_location_x - measureText.width / 2, 
				starty - font_height / 2);
			starty += (font_size * 1.5);
		}



		/*
		starty = 30
		for (let i in evenlist)
		{
			//ctx.font = "lighter " + text_size_to_body_ratio + "px Times New Roman";ctx.font = "lighter " + text_size_to_body_ratio + "px Times New Roman";
			ctx.font = "lighter " + font_size + "px Gabriola";
			ctx.fillStyle = "#eeeeee";
			var measureText = ctx.measureText(Events[evenlist[i]["index"]]["Name"]);
			ctx.fillText(Events[evenlist[i]["index"]]["Name"], 
				centering_location_x - measureText.width / 2, 
				starty);
			starty += (font_size * 1.5);		
		}
		*/

		/*
		for (let i in cached_event_ordering)
		{
			//ctx.font = "lighter " + text_size_to_body_ratio + "px Times New Roman";ctx.font = "lighter " + text_size_to_body_ratio + "px Times New Roman";
			ctx.font = "lighter " + font_size + "px Gabriola";
			ctx.fillStyle = "#eeeeee";
			var measureText = ctx.measureText(Events[cached_event_ordering[i]["index"]]["Name"]);
			ctx.fillText(Events[cached_event_ordering[i]["index"]]["Name"], 
				centering_location_x - measureText.width / 2, 
				starty);
			starty += (font_size * 1.5);		
		}
		*/

		ctx.globalAlpha = 1;
	}
	else
	{
		currently_in_box = false;
	}

	const full_fps_location_x = 3700
	ctx.font = "lighter " + font_size + "px Gabriola";
	ending_location_x = full_fps_location_x / overall_width * startxy.width + startxy.x;
	ctx.fillText(current_fps, ending_location_x, startxy.y + 30);
}

function RedrawBackground(c)
{
	var ctx = c.getContext("2d");
	var r = GetMainRegion(c);

	//ctx.drawImage(web, r.x, r.y, r.width, r.height);
	ctx.drawImage(decorative, r.x, r.y, r.width, r.height);
	ctx.drawImage(looking_glass, r.x, r.y, r.width, r.height);

	ctx.globalAlpha = 0.5;
	ctx.fillStyle = "#FF0000";
	var start = GetBoxCoordsFromNormalizeds(c, 0, 0);
	var end = GetBoxCoordsFromNormalizeds(c, 1, 1);
  //ctx.fillRect(start.x, start.y, end.x - start.x, end.y - start.y);
  ctx.globalAlpha = 1.0;

	ctx.globalAlpha = 0.7;
	ctx.strokeStyle = '#FFFFFF'
	ctx.lineWidth = 2

	startxy = GetMainRegion(c);

	for (let i in Events) {
		var circle = GetBoxCoordsFromNormalizeds(c, Events[i]["X"] / unity_width, Events[i]["Y"] / unity_height);
	  	var radius = GetBoxCoordsFromNormalizeds(c, (Events[i]["X"] + Events[i]["Radius"]) / unity_width, 0).x - GetBoxCoordsFromNormalizeds(c, Events[i]["X"] / unity_width, 0).x;
		//DrawCircle(ctx, circle.x, circle.y, radius, "#FFFFFF");
		//DrawCross(ctx, circle.x, circle.y, radius / 2, "#FFFFFF");
	}
	ctx.stroke();
	ctx.globalAlpha = 1;

	// DrawScrollArea(c);
	DrawReorderingArea(c)
}

let unity_move_speed = 0.035;

let unity_current_pos_x = 0;
let unity_current_pos_y = 0;
let unity_target_pos_x = 0;
let unity_target_pos_y = 0;


let mouse_current_pos_x = 0;
let mouse_current_pos_y = 0;
let mouse_target_pos_x = 0;
let mouse_target_pos_y = 0;

let text_move_speed = 0;


function animate(){
	// console.log("animation");
	let distX = mouse_target_pos_x - mouse_current_pos_x;
	let distY = mouse_target_pos_y - mouse_current_pos_y;

	mouse_current_pos_x = mouse_current_pos_x + (distX * unity_move_speed);
	mouse_current_pos_y = mouse_current_pos_y + (distY * unity_move_speed);

	// Drawing stuff, consider moving to animation step
	var c = document.getElementById("canvas");
	var ctx = c.getContext("2d");
	ctx.clearRect(0, 0, c.width, c.height);
	unityPos = getUnityPosition(c, mouse_current_pos_x, mouse_current_pos_y)
	ctx.drawImage(unity, unityPos.x, unityPos.y, unity_width, unity_height);
	//console.log(unityPos.x, unityPos.y);
	RedrawBackground(c);
	
	const d = new Date();
	let current_second = d.getSeconds()
	
	if (current_fps_second != current_second)
	{
		current_fps_second = current_second;
		current_fps = frames_kept;
		frames_kept = 0;
	}
	frames_kept++;

	requestAnimationFrame(animate);
}

// Gets the Position of a Mouse Pointer on We Are Unity Native Space
function getUnityPosition(c, x, y)
{
	// We need to get the position of the circle, first we need to calculate the y position in the circle
	// x = GetMainRegion...
	// y = GetMainRegion.h / total height * circle_center_y
	var r = GetMainRegion(c);
	circlex = r.x + r.width / 2;
	circley = r.y + circle_center_y / overall_height * r.height; 
	circler = circle_radius / overall_height * r.height;

	// I also need current x, y, in box coords, which I can use to line up.
	var box = GetNormalizedsFromBoxCoords(c, x, y);
	//console.log(box.x, box.y);

	// First of all I want to shift image by boxcoords * unity_width, same for height
	// Then I want to do the half shift to center it. 
	var unity_x = circlex + (1 - box.x) * unity_width - unity_width;
	var unity_y = circley + (1 - box.y) * unity_height - unity_height;

	/*
	var buffer = 20;
	if (unity_x > circlex - circler - buffer) {unity_x = circlex - circler - buffer};
	if (unity_x + unity_width < circlex + circler + buffer) {unity_x = circlex + circler - unity_width + buffer}; 
	if (unity_y > circley - circler - buffer) {unity_y = circley - circler - buffer};
	if (unity_y + unity_height < circley + circler + buffer) {unity_y = circley + circler - unity_height + buffer}; 
	*/

	var output = {
	    x: unity_x,
	    y: unity_y,
	};

	return output;
}

//let unity_target_pos_x = 0;
//let unity_target_pos_y = 0;
function getMousePosition(e)
{
	var output = {
		x: e.clientX + document.body.scrollLeft,
		y: e.clientY + document.body.scrollTop
	};

	return output;
}

function onMouseMove(e)
{
	var c = document.getElementById("canvas");
	x = getMousePosition(e).x;
	y = getMousePosition(e).y;
	cachedEvent = e;
	// Drawing stuff, consider moving to animation step

	var ctx = c.getContext("2d");

	if (IsInBox(c, x, y))
	{
		mouse_target_pos_x = x;
		mouse_target_pos_y = y;
	}

	unityPos = getUnityPosition(c, mouse_target_pos_x, mouse_target_pos_y)

	last_mouse_move_time_ms = Date.now();
}

function RedrawCanvas()
{
	var c = document.getElementById("canvas");

	bodyHeight = innerHeight;
	bodyWidth = innerWidth;
	var bodyRatio = bodyWidth / bodyHeight;
	c.width = Math.max(window.innerWidth, min_width)
	c.height = Math.max(window.innerHeight, min_height)

	var ctx = c.getContext("2d");
	ctx.clearRect(0, 0, c.width, c.height);
	/*
	ctx.moveTo(0, 0);
	ctx.lineTo(c.width, c.height);
	// console.log(c.width, c.height);
	ctx.strokeStyle = '#110000'
	ctx.lineWidth = 10
	ctx.stroke();
	*/
	RedrawBackground(c);
}

$( document ).ready(function() {
    console.log( "ready!" );
	document.addEventListener('mousemove', onMouseMove);
    RedrawCanvas();
	animate();
});

function onResize(){
	RedrawCanvas();
}

function globalToBoxNormalizedCoords()
{

}
